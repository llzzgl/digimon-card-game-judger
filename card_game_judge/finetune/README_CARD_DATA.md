# DTCG 微调数据收集 - 卡牌数据集成

## 概述

本项目已成功集成卡牌数据到微调训练数据中。现在微调数据包含：

1. **规则书问答** - 从官方综合规则提取的规则解释、示例等
2. **官方 Q&A** - 官方裁定和常见问题解答
3. **卡牌数据问答** ✨ **新增** - 从卡牌数据库生成的卡牌信息、效果查询等

## 卡牌数据来源

卡牌数据文件：`digimon_card_data_chiness/digimon_cards_cn.json`

包含 **3992 张卡牌**的完整中文数据，包括：
- 卡牌编号、名称（中文/日文）
- 类型、稀有度、颜色、等级
- 形态、属性、特征
- 登场费用、DP、进化条件
- 效果、进化源效果、安防效果

## 生成的问答类型

### 1. 卡牌基本信息查询（11,925 条）

**通过卡号查询：**
```
问：EX11-026 是什么卡？请提供详细信息。
答：【EX11-026】飞翼兽（プテロモン）
    • 类型：数码兽卡
    • 稀有度：C
    • 颜色：绿
    ...
```

**通过中文名查询：**
```
问：请介绍一下「飞翼兽」这张卡。
答：【EX11-026】飞翼兽（プテロモン）...
```

**通过日文名查询：**
```
问：「プテロモン」是什么卡？
答：「プテロモン」的中文名是「飞翼兽」。
    【EX11-026】飞翼兽（プテロモン）...
```

### 2. 卡牌效果查询（5,540 条）

**主效果查询：**
```
问：EX11-026 飞翼兽 的效果是什么？
答：【EX11-026】飞翼兽
    效果：【移动时】【登场时】你可以将1只数码兽休眠...
```

**进化源效果查询：**
```
问：EX11-026 飞翼兽 的进化源效果是什么？
答：【EX11-026】飞翼兽
    进化源效果：【自己的回合】［1回合1次］这只数码兽在战斗中胜利时，内存值+1。
```

**安防效果查询：**
```
问：XXX 的安防效果是什么？
答：【XXX】...
    安防效果：...
```

### 3. 卡牌搜索（181 条）

**按颜色搜索：**
```
问：请列举一些绿色的卡牌。
答：以下是一些绿色的卡牌：
    • EX11-026 飞翼兽
    • EX11-027 玛机那兽
    ...
```

**按特征搜索：**
```
问：有哪些特征包含「鸟龙型」的数码兽？
答：以下是一些特征包含「鸟龙型」的数码兽：
    • EX11-026 飞翼兽
    ...
```

### 4. 卡牌对比（10 条）

```
问：「滚球兽」有哪些不同版本？
答：「滚球兽」有多个版本：
    【EX11-001】
    • 颜色：红
    • 等级：2
    ...
    【BT01-001】
    • 颜色：红
    • 等级：2
    ...
```

## 数据统计

```
📊 DTCG 微调数据统计
==================================================
规则书问答: 0
官方 Q&A: 2
卡牌数据问答: 17,656
自定义问答: 0
总计: 17,658

📁 来源分布:
   card_data: 11,925      # 卡牌基本信息
   card_effect: 5,540     # 卡牌效果
   card_search: 181       # 卡牌搜索
   card_comparison: 10    # 卡牌对比

🏷️ 标签分布:
   卡牌信息: 11,925
   数码兽卡: 5,952
   日文名: 3,941
   卡牌效果: 3,806
   进化源效果: 1,734
   选项卡: 954
   驯兽师卡: 610
   数码蛋卡: 464
```

## 使用方法

### 1. 收集所有训练数据

```bash
cd card_game_judge/finetune
python collect_all_data.py
```

这将自动：
- 从规则书提取问答（如果存在）
- 加载官方 Q&A（如果存在）
- 加载卡牌数据并生成问答
- 导出为多种格式

### 2. 仅测试卡牌数据加载

```bash
python test_card_data.py
```

### 3. 自定义数据收集

```bash
# 指定卡牌数据路径
python collect_all_data.py --card-data /path/to/digimon_cards_cn.json

# 不加载卡牌数据
python collect_all_data.py --no-cards

# 只导出 JSONL 格式
python collect_all_data.py --format jsonl
```

### 4. 开始微调

```bash
# 使用生成的数据进行微调
python finetune_qwen.py --data training_data/dtcg_finetune_data.jsonl

# 自定义参数
python finetune_qwen.py \
    --data training_data/dtcg_finetune_data.jsonl \
    --model Qwen/Qwen2-1.5B-Instruct \
    --epochs 3 \
    --batch_size 2 \
    --output output/dtcg_qwen_with_cards
```

## 输出文件

数据收集后会生成以下文件：

```
card_game_judge/finetune/training_data/
├── dtcg_finetune_data.jsonl      # 微调格式（推荐用于训练）
├── dtcg_finetune_data.json       # JSON 格式（便于查看和编辑）
└── dtcg_conversation.jsonl       # 对话格式（ChatML 风格）
```

### JSONL 格式示例

```json
{
  "instruction": "你是数码宝贝卡牌游戏(DTCG)的卡牌数据专家。请准确回答关于卡牌信息和效果的问题。",
  "input": "EX11-026 是什么卡？请提供详细信息。",
  "output": "【EX11-026】飞翼兽（プテロモン）\n\n• 类型：数码兽卡\n• 稀有度：C\n..."
}
```

## 代码修改说明

### 1. `data_collector.py` 新增功能

- 添加 `card_qa_pairs` 列表存储卡牌问答
- 添加 `"card"` 系统指令模板
- 新增方法：
  - `load_card_data()` - 加载卡牌数据并生成问答
  - `_generate_card_info_qa()` - 生成卡牌信息问答
  - `_generate_card_effect_qa()` - 生成卡牌效果问答
  - `_generate_card_search_qa()` - 生成卡牌搜索问答
  - `_generate_card_comparison_qa()` - 生成卡牌对比问答
  - `_format_card_info()` - 格式化卡牌完整信息

### 2. 新增脚本

- `test_card_data.py` - 测试卡牌数据加载功能
- `collect_all_data.py` - 完整的数据收集脚本

## 微调效果预期

集成卡牌数据后，微调后的模型将能够：

1. ✅ 准确回答卡牌信息查询（通过卡号、中文名、日文名）
2. ✅ 解释卡牌效果、进化源效果、安防效果
3. ✅ 根据颜色、特征等条件搜索卡牌
4. ✅ 对比同名不同版本的卡牌
5. ✅ 结合规则书知识解释卡牌效果的规则细节

## 注意事项

1. **数据量大**：卡牌数据生成了 17,656 条问答，建议使用较大的模型（如 Qwen2-7B）或增加训练轮数
2. **内存占用**：如果内存不足，可以：
   - 使用 4-bit 量化（默认已启用）
   - 减小 batch size
   - 使用梯度累积
3. **数据平衡**：卡牌数据占比较大，可以考虑：
   - 增加规则书问答的权重
   - 对卡牌数据进行采样
   - 分阶段训练（先训练规则，再训练卡牌）

## 下一步计划

- [ ] 添加更多规则书问答（需要规则书文件）
- [ ] 收集官方 Q&A 数据
- [ ] 生成卡牌组合和策略相关的问答
- [ ] 添加数据增强（同义词替换、问题改写等）
- [ ] 实现数据采样和平衡策略

## 问题反馈

如有问题或建议，请联系开发者。
